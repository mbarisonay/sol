@model user_panel.ViewModels.CreateBookingViewModel

@{
    ViewData["Title"] = "Create Booking";
}

<style>
    .time-slot {
        border: 1px solid var(--border-color);
        background-color: #3d3d45;
        color: var(--text-light);
        transition: all 0.2s ease-in-out;
    }

        .time-slot.booked {
            background-color: #5a2a2a;
            color: #aaa;
            text-decoration: line-through;
            cursor: not-allowed;
        }

        .time-slot:not(.booked):hover {
            background-color: var(--brand-accent);
            color: white;
            transform: translateY(-2px);
        }
</style>

<div class="container container-main-large">
    <div class="card-custom">
        <h2 class="text-center">Book Cabin: <span class="text-primary">@Model.Cabin.District.City.Name / @Model.Cabin.District.Name</span></h2>
        <p class="text-center text-muted mb-4">Select a date and an available time slot below.</p>

        <form asp-action="Create" method="get" class="mb-4">
            <input type="hidden" name="id" value="@Model.Cabin.Id" />
            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label for="bookingDate" class="form-label text-light">Select Date</label>
                    <!-- =================================================================== -->
                    <!-- === THE FIX IS HERE: min="@Model.MinBookingDate" IS ADDED      === -->
                    <!-- =================================================================== -->
                    <input type="date"
                           id="bookingDate"
                           name="bookingDate"
                           value="@Model.BookingDate.ToString("yyyy-MM-dd")"
                           min="@Model.MinBookingDate"
                           class="form-control" />
                </div>
            </div>
        </form>

        <hr style="border-color: var(--border-color-light);" />

        <h4 class="text-light mt-4">Available Times for <span class="text-primary">@Model.BookingDate.ToString("D")</span></h4>
        <div class="row g-3 mt-2">
            @for (int hour = 9; hour < 22; hour++)
            {
                var isBooked = Model.BookedHours.Contains(hour);
                var isPast = Model.BookingDate.Date == DateTime.Today && hour < DateTime.Now.Hour;
                var isSelectable = !isBooked && !isPast;
                var slotClass = isSelectable ? "" : "booked";
                var startTime = new DateTime(Model.BookingDate.Year, Model.BookingDate.Month, Model.BookingDate.Day, hour, 0, 0);

                <div class="col-md-3 col-sm-4 col-6">
                    @if (isSelectable)
                    {
                        <form asp-action="Create" method="post" class="h-100">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="cabinId" value="@Model.Cabin.Id" />
                            <input type="hidden" name="bookingDate" value="@Model.BookingDate.ToString("yyyy-MM-dd")" />
                            <input type="hidden" name="startTimeHour" value="@hour" />
                            <button type="submit" class="btn time-slot w-100 h-100 text-center p-3">
                                @startTime.ToString("HH:00") - @startTime.AddHours(1).ToString("HH:00")
                            </button>
                        </form>
                    }
                    else
                    {
                        <div class="btn time-slot @slotClass w-100 h-100 text-center p-3">
                            @startTime.ToString("HH:00") - @startTime.AddHours(1).ToString("HH:00")
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>