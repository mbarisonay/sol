@model user_panel.Data.Cabin
@using Microsoft.AspNetCore.Identity

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = $"Details for {Model.District.City.Name} / {Model.District.Name}";
}


@section Styles {
    @* UserPanel ile aynı stil dosyasını kullanarak tutarlı bir görünüm sağlıyoruz *@
    <link rel="stylesheet" href="~/css/user-panel.css" asp-append-version="true" />
}

<div class="container container-main-large">
    <div class="card-custom">
        <h2 class="text-center" style="color: var(--brand-accent);">
            @Model.District.City.Name / @Model.District.Name
        </h2>
        <p class="text-center text-muted mb-4">Cabin Information & Location</p>

        <div class="row">
            <!-- Left Side: Information & Images -->
            <div class="col-lg-6">
                <h4>Description</h4>
                <p class="text-light">@Model.Description</p>

                <h4 class="mt-4">Price</h4>
                <p class="fs-4 fw-bold" style="color: var(--text-light);">
                    @Model.PricePerHour.ToString("C")/hour
                </p>

                <!-- Placeholder for Images -->
                <h4 class="mt-4">Gallery</h4>
                <div class="mb-3">
                    <img src="@(Model.ImageUrl)" class="img-fluid rounded w-100" alt="Cabin Image">
                </div>

                @if (SignInManager.IsSignedIn(User))
                {
                    <a asp-controller="Booking" asp-action="Create" asp-route-id="@Model.Id"
                       class="btn btn-primary btn-lg mt-4 w-100">
                        Book This Cabin
                    </a>
                }
                else
                {
                    <a asp-controller="Account" asp-action="Login"
                       class="btn btn-primary btn-lg mt-4 w-100">
                        Login To Book This Cabin
                    </a>
                }
            </div>

            <!-- Right Side: Google Map -->
            <div class="col-lg-6">
                <h4>Exact Location</h4>
                <div id="details-map-canvas" style="width: 100%; height: 450px; border-radius: 8px;"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let map;

        function initMap() {
            const cabinLocation = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            $"{Model.District.Name}, {Model.District.City.Name}, Turkey"
        ));

            const geocoder = new google.maps.Geocoder();
            const mapCanvas = document.getElementById("details-map-canvas");

            geocoder.geocode({ 'address': cabinLocation }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const location = results[0].geometry.location;

                    map = new google.maps.Map(mapCanvas, {
                        zoom: 15,
                        center: location,
                    });

                    new google.maps.Marker({
                        position: location,
                        map: map,
                        title: cabinLocation
                    });

                } else {
                    console.error(`Geocode failed for "${cabinLocation}" with status: ${status}`);
                    mapCanvas.innerHTML = '<div class="alert alert-danger">Sorry, the map location could not be found.</div>';
                }
            });
        }
    </script>

    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA8D4toLWhdieE3j2CFoIV6mzUiSUpWCY0&callback=initMap">
    </script>
}
